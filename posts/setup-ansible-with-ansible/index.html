<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.81.0" />

  <title>Setting Up Ansible with Ansible &middot; Kevin Guay</title>

  <meta name="description" content="How to use Ansible for initial Ansible configuration" />

  

<meta itemprop="name" content="Setting Up Ansible with Ansible">
<meta itemprop="description" content="How to use Ansible for initial Ansible configuration"><meta itemprop="datePublished" content="2017-10-31T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2017-10-31T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="841">
<meta itemprop="keywords" content="Ansible," />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Setting Up Ansible with Ansible"/>
<meta name="twitter:description" content="How to use Ansible for initial Ansible configuration"/>


<meta property="og:title" content="Setting Up Ansible with Ansible" />
<meta property="og:description" content="How to use Ansible for initial Ansible configuration" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.kevinguay.com/posts/setup-ansible-with-ansible/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-10-31T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2017-10-31T00:00:00&#43;00:00" />




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type":"Person",
      "@id": "https://www.kevinguay.com/#author",
      "name": "Kevin Guay",
      "image": {
        "@type":"ImageObject",
        
        "url": "https://www.kevinguay.com/images/profile.png"
        
      },
      "description": "tech / dev / security"
    },
    {
      "@type": "WebSite",
      "@id": "https://www.kevinguay.com/#website",
      "url": "https://www.kevinguay.com/",
      "name": "Kevin Guay",
      "description": "tech / dev / security",
      "publisher": {
        "@id": "https://www.kevinguay.com/#author"
      },
      "inLanguage": "en-us"
    },
    {
      "@type": "WebPage",
      "@id": "https://www.kevinguay.com/posts/setup-ansible-with-ansible/#webpage",
      "url": "https://www.kevinguay.com/posts/setup-ansible-with-ansible/",
      "name": "Setting Up Ansible with Ansible",
      "isPartOf": {
        "@id": "https://www.kevinguay.com/#website"
      },
      "about": {
         "@id": "https://www.kevinguay.com/#author"
      },
      "datePublished": "2017-10-31T00:00:00+00:00",
      "dateModified": "2017-10-31T00:00:00+00:00",
      "description": "How to use Ansible for initial Ansible configuration",
      "inLanguage": "en-us",
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "https://www.kevinguay.com/posts/setup-ansible-with-ansible/"
          ]
        }
      ]
    },
    {
      "@type": "Article",
      "isPartOf": {
        "@id": "https://www.kevinguay.com/posts/setup-ansible-with-ansible/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "https://www.kevinguay.com/posts/setup-ansible-with-ansible/#webpage"
      },
      "headline": "Setting Up Ansible with Ansible",
      "datePublished": "2017-10-31T00:00:00+00:00",
      "dateModified": "2017-10-31T00:00:00+00:00",
      "publisher": {
        "@id": "https://www.kevinguay.com/#author"
      },
      "keywords": [
        "Ansible"
      ],
      "articleSection": [
      ],
      "inLanguage": "en-us",
      "author": {
        "@type": "Person",
        "name":  null 
      },
      "potentialAction": [
        {
          "@type": "CommentAction",
          "name": "Comment",
          "target": [
            "https://www.kevinguay.com/posts/setup-ansible-with-ansible/#comments"
          ]
        }
      ]
    }
  ]
}
</script>




  <link type="text/css"
        rel="stylesheet"
        href="/css/print.css"
        media="print">

  <link type="text/css"
        rel="stylesheet"
        href="/css/poole.css">

  <link type="text/css"
        rel="stylesheet"
        href="/css/hyde.css">

  
<style type="text/css">
  .sidebar {
    background-color: #3563A0;
  }

  .read-more-link a {
    border-color: #3563A0;
  }

  .read-more-link a:hover {
    background-color: #3563A0;
  }

  .pagination li a {
    color: #3563A0;
    border: 1px solid #3563A0;
  }

  .pagination li.active a {
    background-color: #3563A0;
  }

  .pagination li a:hover {
    background-color: #3563A0;
    opacity: 0.75;
  }

  footer a,
  .content a,
  .related-posts li a:hover {
    color: #3563A0;
  }
</style>



  <link type="text/css" rel="stylesheet" href="/css/main.css">

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed"
        sizes="144x144"
        href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109988049-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-109988049-1');
  </script>
    
</head>
<body>
  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <a href="https://www.kevinguay.com/">
            <img src="/images/profile.png" class="img-circle img-headshot center" alt="Profile Picture">
          </a>
        </div>
        
      

      <h1><a href="/posts/setup-ansible-with-ansible/">Kevin Guay</a></h1>

      
      <p class="lead">tech / dev / security</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://www.kevinguay.com/">Home</a>
        </li>
        <li>
          <a href="/posts/">Posts</a>
        </li><li>
          <a href="/tags/">Tags</a>
        </li><li>
          <a href="/about/">About</a>
        </li><li>
          <a href="/consulting/">Consulting</a>
        </li><li>
          <a href="/resume/">Resume</a>
        </li>
      </ul>
    </nav>
    
    hello@kevinguay.com
    
    <section class="social-icons">
      
      <a href="https://www.linkedin.com/in/kevincguay/" rel="me" title="Linkedin" target="_blank">
        <i class="fab fa-linkedin" aria-hidden="true"></i>
      </a>
      
      <a href="https://github.com/kguay" rel="me" title="GitHub" target="_blank">
        <i class="fab fa-github" aria-hidden="true"></i>
      </a>
      
      <a href="https://twitter.com/kevincguay" rel="me" title="Twitter" target="_blank">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
      
      <a href="https://instagram.com/kevin.c.guay" rel="me" title="Instagram" target="_blank">
        <i class="fab fa-instagram" aria-hidden="true"></i>
      </a>
      
    </section>
  </div>
</aside>


  <main class="content container">
  <div class="post">
  <h1 class="title">Setting Up Ansible with Ansible</h1>
  

  <div class="post-date">
    <time datetime="2017-10-31T00:00:00Z">Oct 31, 2017</time> <span class="readtime">&middot; 4 min read</span>
  </div>

  
<div>
  <ul class="tags">
  <li>
    <a href="https://www.kevinguay.com/tags/ansible/" class="tag-link">Ansible</a>
  </li>
  </ul>
</div>



  <div>
  <h2 id="background">Background</h2>
<p>I am responsible for a few dozen linux servers at work, and although there was an effort to install Salt a few years ago, they are all managed individually and manually. I spend more time than I should ssh&rsquo;ing into boxes to add users. install applications, or restart services. I looked into Puppet a few months ago, but it seemed to complicated and clunky for my environment. Specialty, I really didn&rsquo;t want to install and troubleshoot the client on dozens of serveres. A few people had recommended Ansible to me, and it looked like a gerat option.</p>
<!-- raw HTML omitted -->
<p>After waiting two months for the second edition to come out, I picked up a copy of Ansible Up &amp; Running by Lorin Hochstien and Rene Moser. Realizing that I wouldn&rsquo;t have time to read through the text at work, it became my nighttime reading. After only one chapter, I felt confident that it was the right choice for my current environment (~40 CentOS and RHEL virtual and physical machines.) It was easy to install on my mac using Homebrew and just as easy to start using. Best of all, I didn&rsquo;t have to ssh into every machine on the network to install a client, but I did need to create Ansible users on the machines.</p>
<p>That meant, for 40+ servers, I needed to:</p>
<ul>
<li>create an ansible user</li>
<li>add the user to wheel</li>
<li>enable passwordless sudo for that user</li>
<li>add a public key to the user&rsquo;s authorize_keys file</li>
</ul>
<p>That would have taken me at least a few hours and I would have probably misconfigured at least one of the servers. That was before Ansible. From what I had learned in the first chapter, I was able to use my current user account (in wheel) to run the needed configuration without manually logging into each machine.</p>
<h2 id="heres-how-i-did-it">Here&rsquo;s how I did it:</h2>
<h3 id="configuration">Configuration:</h3>
<p>In the configuration file (<code>ansible.cfg</code>), I set the remote user to myself, and instead of using a private key for authentication, I set the <code>ask_pass</code> flag to true. With this flag set, Ansible will prompt me for my password <em>once</em> when I run the playbook. I have also disabled host key checking (<code>host_key_checking = False</code>) to speed things up.</p>
<pre><code>[defaults]
inventory = hosts
remote_user = kguay
ask_pass = True
host_key_checking = False
ansible_port = 22
</code></pre><h3 id="playbook">Playbook:</h3>
<p>Since we don&rsquo;t use passwordless sudo for anything other than Ansible, that line in the sudoers file was commented out. I used that comment in the regular expression (see last section below) to select the correct line in sudoers (if you don&rsquo;t use that comment in your RE, it will select the wrong line, enabling passwordless ssh for all users in wheel). Instead of setting it to <code>%wheel ALL=(ALL) NOPASSWD: ALL</code>, I specified the ansible user. As much as I dread typing in my password twice, it is worth it to prevent accidental sudo&rsquo;s.</p>
<pre><code>- name: Add users
  hosts: all
  become: True
  tasks:
    - group:
        name: ansible
        gid: 2000
        state: present
    
    - user:
        name: ansible
        comment: &quot;Ansible&quot;
        uid: 2000
        group: ansible
        groups: wheel
    
    - name: Set authorized key took from file
      authorized_key:
        user: ansible
        state: present
        key: &quot;{{ lookup('file', 'id-rsa.pub') }}&quot;
    
    - name: Allow 'wheel' group to have passwordless sudo
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^# %wheel'
        line: '%ansible ALL=(ALL) NOPASSWD: ALL'
</code></pre><h3 id="running-the-playbook">Running the playbook:</h3>
<p>When I run the playbook, I use the <code>--ask-become-pass</code> (<code>-K</code>) option to prompt the user for the sudo password. You should be prompted twice (once for the user password and once for the sudo password). In most cases these will be the same, but you still need to enter it twice.</p>
<pre><code>$ ansible-playbook --ask-become-pass ansible_user.yml
</code></pre><p>You should get some output similar to:</p>
<pre><code>$ ansible-playbook --ask-become-pass ansible_user.yml
SSH password:
SUDO password[defaults to SSH password]:

PLAY [Add users] *****************************************

TASK [Gathering Facts] ***********************************
ok: [server1]
ok: [server2]

TASK [group] *********************************************
ok: [server1]
ok: [server2]

TASK [user] **********************************************
ok: [server1]
ok: [server2]

TASK [Set authorized key took from file] *****************
ok: [server1]
ok: [server2]

TASK [Allow 'wheel' group to have passwordless sudo] *****
changed: [server1]
changed: [server2]

PLAY RECAP ***********************************************
server1   : ok=5    changed=1    unreachable=0    failed=0
server2   : ok=5    changed=1    unreachable=0    failed=0
</code></pre><p>If you see a bunch of ok&rsquo;s, then you are done. You can log onto one of the servers to check that the ansible user has been created, is in wheel, and can sudo without a password.</p>
<p>To start using the new ansible user account, you will need to edit the <em>third</em> and <em>fourth</em> line in your configuration file, <code>ansible.cfg</code>. On the <em>fourth</em> line, use the private key that corresponds to the public key that you used in your playbook (here, id-rsa):</p>
<pre><code>[defaults]
inventory = hosts
remote_user = ansible
private_key_file = id-rsa
host_key_checking = False
ansible_port = 22
</code></pre><h2 id="conclusion">Conclusion</h2>
<p>While I have only scratched the surface of what Ansible can do, it is clearly as powerful as it is light weight. I can&rsquo;t wait to dive in an spend more time programming and less time managing servers!</p>
<p>You can find all of the code in this post in a <a href="https://gist.github.com/kguay/7c3122aedb1b19eba69fc3fbe5c420de"> GitHub Gist</a>.</p>
<!-- raw HTML omitted -->

  </div>

  <hr>
  
  
    Previous: <a href="/posts/new-website-and-blog/">New website and blog</a>
  
  <br>
  
    Next: <a href="/posts/mounting-cifs-in-centos/">Mounting CIFS in CentOS 7</a>
  
  
  <div class="share-buttons">
  <a class="twitter-share-button"
     href="#"
     title="Share on Twitter"
     data-url="https://www.kevinguay.com/posts/setup-ansible-with-ansible/"
     data-text="Setting Up Ansible with Ansible"><i class="fab fa-twitter"></i></a>

  <a class="linkedin-share-button"
     href="#"
     title="Share on LinkedIn"
     data-url="https://www.kevinguay.com/posts/setup-ansible-with-ansible/"
     data-text="Setting Up Ansible with Ansible"><i class="fab fa-linkedin-in"></i></a>

  <a class="facebook-share-button"
     href="#"
     title="Share on Facebook"
     data-url="https://www.kevinguay.com/posts/setup-ansible-with-ansible/"
     data-text="Setting Up Ansible with Ansible"><i class="fab fa-facebook"></i></a>

  <a class="telegram-share-button"
     href="#"
     title="Share on Telegram"
     data-url="https://www.kevinguay.com/posts/setup-ansible-with-ansible/"
     data-text="Setting Up Ansible with Ansible"><i class="fab fa-telegram"></i></a>

  <a class="pinterest-share-button"
     href="#"
     title="Share on Pinterest"
     data-url="https://www.kevinguay.com/posts/setup-ansible-with-ansible/"
     data-text="Setting Up Ansible with Ansible"><i class="fab fa-pinterest"></i></a>
</div>


  
  

  
</div>
  </main>

  <footer>
  <div>
    <p>
      &copy; Kevin Guay 2021

      &middot; <a href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank">CC BY-SA 4.0</a>

      
    </p>
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
          integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
          crossorigin="anonymous"></script>


  <script src="/js/jquery.min.js"></script>
  <script src="/js/soho.js"></script>

  <script src="/js/blog.js"></script>

  
</body>
</html>
